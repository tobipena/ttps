<div class="listado-container">
  <div class="container py-4">
    <!-- Header -->
    <div class="page-header">
      <h1>Mascotas Perdidas</h1>
      <p>Ayúdanos a encontrarlas</p>
    </div>

    <!-- Filtros -->
    <div class="filtros-card">
      <h5 class="filtros-title">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
        </svg>
        Filtros de Búsqueda
      </h5>
      
      <div class="row g-3">
        <!-- Provincia -->
        <div class="col-md-3">
          <label class="form-label">Provincia</label>
          <select class="form-select" [(ngModel)]="filtros.provincia" (change)="onProvinciaChange()">
            <option value="">Todas</option>
            @for (provincia of provincias; track provincia.id) {
              <option [value]="provincia.id">{{ provincia.nombre }}</option>
            }
          </select>
        </div>

        <!-- Ciudad -->
        <div class="col-md-3">
          <label class="form-label">Ciudad</label>
          <select class="form-select" [(ngModel)]="filtros.ciudad" (change)="aplicarFiltros()" [disabled]="!filtros.provincia || loadingCiudades">
            <option value="">Todas</option>
            @if (loadingCiudades) {
              <option disabled>Cargando...</option>
            }
            @for (ciudad of ciudades; track ciudad.id) {
              <option [value]="ciudad.nombre">{{ ciudad.nombre }}</option>
            }
          </select>
        </div>

        <!-- Animal -->
        <div class="col-md-3">
          <label class="form-label">Tipo de Animal</label>
          <select class="form-select" [(ngModel)]="filtros.animal" (change)="aplicarFiltros()">
            <option value="">Todos</option>
            @for (animal of animales; track animal) {
              <option [value]="animal">{{ animal }}</option>
            }
          </select>
        </div>

        <!-- Tamaño -->
        <div class="col-md-3">
          <label class="form-label">Tamaño</label>
          <select class="form-select" [(ngModel)]="filtros.tamano" (change)="aplicarFiltros()">
            <option value="">Todos</option>
            @for (tamano of tamanos; track tamano) {
              <option [value]="tamano">{{ tamano }}</option>
            }
          </select>
        </div>
      </div>

      <!-- Botón limpiar filtros -->
      <div class="text-end mt-3">
        <button class="btn-limpiar" (click)="limpiarFiltros()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="1 4 1 10 7 10"/>
            <polyline points="23 20 23 14 17 14"/>
            <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
          </svg>
          Limpiar Filtros
        </button>
      </div>
    </div>

    <!-- Loading State -->
    @if (loading) {
      <div class="loading-container">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="loading-text">Cargando desapariciones...</p>
      </div>
    }

    <!-- Grid de Desapariciones -->
    @if (!loading && desapariciones.length > 0) {
      <div class="row g-4 mb-4">
        @for (desaparicion of desapariciones; track desaparicion.id) {
          <div class="col-12 col-sm-6 col-md-4 col-lg-3">
            <div class="mascota-card">
              <div class="card-image">
                @if (getPrimeraImagen(desaparicion.mascota)) {
                  <img [src]="'data:image/jpeg;base64,' + getPrimeraImagen(desaparicion.mascota)" 
                       [alt]="desaparicion.mascota.nombre"
                       class="img-fluid">
                } @else {
                  <div class="no-image">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                      <circle cx="9" cy="9" r="2"/>
                      <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
                    </svg>
                    <p>Sin imagen</p>
                  </div>
                }
              </div>

              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h5 class="card-title mb-0">{{ desaparicion.mascota.nombre }}</h5>
                  <span class="badge bg-primary">{{ desaparicion.mascota.animal }}</span>
                </div>
                
                <p class="card-text mb-2">
                  <small>
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/>
                      <circle cx="12" cy="10" r="3"/>
                    </svg>
                    @if (desaparicion.ciudad && desaparicion.provincia) {
                      {{ desaparicion.ciudad }}, {{ desaparicion.provincia }}
                    } @else {
                      <span class="text-muted">Ubicación no disponible</span>
                    }
                  </small>
                </p>

                <p class="card-text mb-2">
                  <small>
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="12" cy="12" r="10"/>
                      <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    {{ desaparicion.fecha | date:'dd/MM/yyyy' }}
                  </small>
                </p>

                <div class="mb-2 d-flex gap-1 flex-wrap">
                  <span class="badge bg-secondary badge-truncate">{{ desaparicion.mascota.tamano }}</span>
                  <span class="badge bg-secondary badge-truncate">{{ desaparicion.mascota.color }}</span>
                </div>

                <p class="card-text small">{{ desaparicion.comentario }}</p>

                <a [routerLink]="['/desaparicion', desaparicion.id]" class="btn btn-primary btn-sm w-100 mt-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                  </svg>
                  Ver Detalles
                </a>
              </div>
            </div>
          </div>
        }
      </div>

      <!-- Paginación -->
      @if (totalPages > 1) {
        <nav aria-label="Paginación">
          <ul class="pagination">
            <!-- Primera página -->
            <li class="page-item" [class.disabled]="currentPage === 0">
              <a class="page-link" (click)="changePage(0)" [attr.tabindex]="currentPage === 0 ? -1 : null">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="11 17 6 12 11 7"/>
                  <polyline points="18 17 13 12 18 7"/>
                </svg>
              </a>
            </li>

            <!-- Anterior -->
            <li class="page-item" [class.disabled]="currentPage === 0">
              <a class="page-link" (click)="changePage(currentPage - 1)" [attr.tabindex]="currentPage === 0 ? -1 : null">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="15 18 9 12 15 6"/>
                </svg>
              </a>
            </li>

            <!-- Páginas -->
            @for (page of getPages(); track page) {
              <li class="page-item" [class.active]="currentPage === page">
                <a class="page-link" (click)="changePage(page)">{{ page + 1 }}</a>
              </li>
            }

            <!-- Siguiente -->
            <li class="page-item" [class.disabled]="currentPage === totalPages - 1">
              <a class="page-link" (click)="changePage(currentPage + 1)" [attr.tabindex]="currentPage === totalPages - 1 ? -1 : null">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="9 18 15 12 9 6"/>
                </svg>
              </a>
            </li>

            <!-- Última página -->
            <li class="page-item" [class.disabled]="currentPage === totalPages - 1">
              <a class="page-link" (click)="changePage(totalPages - 1)" [attr.tabindex]="currentPage === totalPages - 1 ? -1 : null">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="13 17 18 12 13 7"/>
                  <polyline points="6 17 11 12 6 7"/>
                </svg>
              </a>
            </li>
          </ul>
        </nav>

        <!-- Información de paginación -->
        <p class="pagination-info">
          Mostrando {{ (currentPage * pageSize) + 1 }} - {{ Math.min((currentPage + 1) * pageSize, totalElements) }} de {{ totalElements }} resultados
        </p>
      }
    }

    <!-- Sin resultados -->
    @if (!loading && desapariciones.length === 0) {
      <div class="no-results">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
          <line x1="11" y1="8" x2="11" y2="14"/>
          <line x1="11" y1="16" x2="11.01" y2="16"/>
        </svg>
        <h4>No se encontraron resultados</h4>
        <p>Intenta ajustar los filtros de búsqueda</p>
      </div>
    }
  </div>
</div>
